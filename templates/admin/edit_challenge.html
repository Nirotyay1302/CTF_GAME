{% extends "admin/base.html" %}

{% block title %}Edit Challenge - Admin Panel{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('admin_challenges') }}">Challenges</a></li>
<li class="breadcrumb-item active">Edit Challenge</li>
{% endblock %}

{% block extra_css %}
<style>
    .form-container {
        max-width: 800px;
        margin: 0 auto;
    }
    
    .form-section {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border: 1px solid var(--admin-border);
    }
    
    .form-section h3 {
        color: var(--admin-primary);
        margin-bottom: 1.5rem;
        font-size: 1.25rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .form-group {
        margin-bottom: 1.5rem;
    }
    
    .form-label {
        font-weight: 600;
        color: var(--admin-text);
        margin-bottom: 0.5rem;
        display: block;
    }
    
    .form-control {
        border: 2px solid var(--admin-border);
        border-radius: 8px;
        padding: 0.75rem;
        font-size: 0.875rem;
        transition: all 0.3s ease;
    }
    
    .form-control:focus {
        border-color: var(--admin-primary);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        outline: none;
    }
    
    .form-select {
        border: 2px solid var(--admin-border);
        border-radius: 8px;
        padding: 0.75rem;
        font-size: 0.875rem;
        background-color: white;
        transition: all 0.3s ease;
    }
    
    .form-select:focus {
        border-color: var(--admin-primary);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        outline: none;
    }
    
    .btn-group {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
        margin-top: 2rem;
    }
    
    .btn {
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        text-decoration: none;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .btn-primary {
        background: var(--admin-primary);
        color: white;
    }
    
    .btn-primary:hover {
        background: #1d4ed8;
        transform: translateY(-2px);
    }
    
    .btn-secondary {
        background: #6b7280;
        color: white;
    }
    
    .btn-secondary:hover {
        background: #4b5563;
        color: white;
        text-decoration: none;
    }
    
    .btn-danger {
        background: var(--admin-danger);
        color: white;
    }
    
    .btn-danger:hover {
        background: #dc2626;
        color: white;
        text-decoration: none;
    }
    
    .help-text {
        font-size: 0.75rem;
        color: var(--admin-text-light);
        margin-top: 0.25rem;
    }
    
    .challenge-info {
        background: #f8fafc;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 2rem;
        border-left: 4px solid var(--admin-primary);
    }
    
    .challenge-meta {
        display: flex;
        gap: 1rem;
        margin-top: 0.5rem;
    }
    
    .meta-item {
        font-size: 0.875rem;
        color: var(--admin-text-light);
    }
    
    .difficulty-badges {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }
    
    .difficulty-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    .difficulty-easy { background: #dcfce7; color: #166534; }
    .difficulty-medium { background: #fef3c7; color: #92400e; }
    .difficulty-hard { background: #fee2e2; color: #991b1b; }
    .difficulty-expert { background: #ede9fe; color: #5b21b6; }
</style>
{% endblock %}

{% block content %}
<div class="form-container">
    <div class="admin-header">
        <h1><i class="fas fa-edit"></i> Edit Challenge</h1>
        <p>Modify the challenge details. Changes will be applied immediately.</p>
    </div>

    <!-- Challenge Info -->
    <div class="challenge-info">
        <h4>{{ challenge.title }}</h4>
        <div class="challenge-meta">
            <span class="meta-item"><i class="fas fa-calendar"></i> Created: {{ challenge.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
            <span class="meta-item"><i class="fas fa-trophy"></i> {{ challenge.points }} points</span>
            <span class="meta-item"><i class="fas fa-tag"></i> {{ challenge.category|title }}</span>
        </div>
    </div>

    <form method="POST" action="{{ url_for('admin_edit_challenge', challenge_id=challenge.id) }}">
        <!-- Basic Information -->
        <div class="form-section">
            <h3><i class="fas fa-info-circle"></i> Basic Information</h3>
            
            <div class="form-group">
                <label for="title" class="form-label">Challenge Title *</label>
                <input type="text" class="form-control" id="title" name="title" required 
                       value="{{ challenge.title }}" placeholder="Enter challenge title">
                <div class="help-text">A clear, descriptive title for the challenge</div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="category" class="form-label">Category *</label>
                        <select class="form-select" id="category" name="category" required>
                            <option value="">Select Category</option>
                            <option value="web" {% if challenge.category == 'web' %}selected{% endif %}>Web</option>
                            <option value="crypto" {% if challenge.category == 'crypto' %}selected{% endif %}>Cryptography</option>
                            <option value="reverse" {% if challenge.category == 'reverse' %}selected{% endif %}>Reverse Engineering</option>
                            <option value="pwn" {% if challenge.category == 'pwn' %}selected{% endif %}>Binary Exploitation</option>
                            <option value="forensics" {% if challenge.category == 'forensics' %}selected{% endif %}>Forensics</option>
                            <option value="stego" {% if challenge.category == 'stego' %}selected{% endif %}>Steganography</option>
                            <option value="misc" {% if challenge.category == 'misc' %}selected{% endif %}>Miscellaneous</option>
                            <option value="osint" {% if challenge.category == 'osint' %}selected{% endif %}>OSINT</option>
                            <option value="network" {% if challenge.category == 'network' %}selected{% endif %}>Networking</option>
                        </select>
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="form-group">
                        <label for="difficulty" class="form-label">Difficulty *</label>
                        <select class="form-select" id="difficulty" name="difficulty" required>
                            <option value="easy" {% if challenge.difficulty == 'easy' %}selected{% endif %}>Easy</option>
                            <option value="medium" {% if challenge.difficulty == 'medium' %}selected{% endif %}>Medium</option>
                            <option value="hard" {% if challenge.difficulty == 'hard' %}selected{% endif %}>Hard</option>
                            <option value="expert" {% if challenge.difficulty == 'expert' %}selected{% endif %}>Expert</option>
                        </select>
                        <div class="difficulty-badges">
                            <span class="difficulty-badge difficulty-easy">Easy</span>
                            <span class="difficulty-badge difficulty-medium">Medium</span>
                            <span class="difficulty-badge difficulty-hard">Hard</span>
                            <span class="difficulty-badge difficulty-expert">Expert</span>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="form-group">
                        <label for="points" class="form-label">Points *</label>
                        <input type="number" class="form-control" id="points" name="points" 
                               value="{{ challenge.points }}" min="1" max="1000" required>
                        <div class="help-text">Points awarded for solving</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Challenge Content -->
        <div class="form-section">
            <h3><i class="fas fa-file-alt"></i> Challenge Content</h3>
            
            <div class="form-group">
                <label for="description" class="form-label">Description *</label>
                <textarea class="form-control" id="description" name="description" rows="6" required
                          placeholder="Enter the challenge description. This is what participants will see.">{{ challenge.description }}</textarea>
                <div class="help-text">Provide clear instructions and any necessary context for the challenge</div>
            </div>
            
            <div class="form-group">
                <label for="flag" class="form-label">Flag *</label>
                <input type="text" class="form-control" id="flag" name="flag" required
                       value="{{ current_flag }}" placeholder="CTF{example_flag_here}">
                <div class="help-text">The correct flag that participants need to find. Usually in format: CTF{...}</div>
            </div>
        </div>

        <!-- Solution Information -->
        <div class="form-section">
            <h3><i class="fas fa-lightbulb"></i> Solution Information</h3>
            
            <div class="form-group">
                <label for="answer_explanation" class="form-label">Answer Explanation</label>
                <textarea class="form-control" id="answer_explanation" name="answer_explanation" rows="4"
                          placeholder="Explain the concept or vulnerability behind this challenge">{{ challenge.answer_explanation or '' }}</textarea>
                <div class="help-text">Educational explanation of the challenge concept (optional)</div>
            </div>
            
            <div class="form-group">
                <label for="solution_steps" class="form-label">Solution Steps</label>
                <textarea class="form-control" id="solution_steps" name="solution_steps" rows="6"
                          placeholder="Step-by-step solution walkthrough">{{ challenge.solution_steps or '' }}</textarea>
                <div class="help-text">Detailed steps to solve the challenge (optional)</div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="btn-group">
            <a href="{{ url_for('admin_challenges') }}" class="btn btn-secondary">
                <i class="fas fa-times"></i> Cancel
            </a>
            <button type="button" class="btn btn-danger" onclick="deleteChallenge()">
                <i class="fas fa-trash"></i> Delete
            </button>
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i> Save Changes
            </button>
        </div>
    </form>
</div>

<script>
// Auto-suggest points based on difficulty
document.getElementById('difficulty').addEventListener('change', function() {
    const pointsInput = document.getElementById('points');
    const difficulty = this.value;
    
    const pointsSuggestions = {
        'easy': 100,
        'medium': 200,
        'hard': 300,
        'expert': 500
    };
    
    if (pointsSuggestions[difficulty] && confirm('Update points to suggested value for this difficulty?')) {
        pointsInput.value = pointsSuggestions[difficulty];
    }
});

// Flag format validation
document.getElementById('flag').addEventListener('input', function() {
    const flag = this.value;
    if (flag && !flag.startsWith('CTF{')) {
        this.style.borderColor = '#f59e0b';
    } else {
        this.style.borderColor = '';
    }
});

// Delete challenge function
function deleteChallenge() {
    if (confirm('Are you sure you want to delete this challenge? This action cannot be undone and will remove all associated solves and submissions.')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{{ url_for("admin_delete_challenge", challenge_id=challenge.id) }}';
        document.body.appendChild(form);
        form.submit();
    }
}
</script>
{% endblock %}