{% extends "base.html" %}

{% block title %}{{ challenge.title }} - HUNTING-CTF{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-4">
    <div class="row">
        <!-- Challenge Content -->
        <div class="col-lg-8">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0 fw-bold">
                            <i class="fas fa-flag me-2"></i>
                            {{ challenge.title }}
                        </h4>
                        <div class="challenge-meta">
                            <span class="badge bg-light text-dark me-2 fs-6">
                                <i class="fas fa-star me-1"></i>{{ challenge.points }} pts
                            </span>
                            <span class="badge bg-{{ 'success' if solve else 'secondary' }} fs-6">
                                <i class="fas fa-{{ 'check' if solve else 'lock' }} me-1"></i>
                                {{ 'Solved' if solve else 'Unsolved' }}
                            </span>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="challenge-description mb-4">
                        <h5 class="text-primary fw-bold"><i class="fas fa-info-circle me-2"></i>Description</h5>
                        <p class="fs-5 p-2 bg-light rounded">{{ challenge.description }}</p>
                    </div>

                    {% if challenge.attachment %}
                    <div class="challenge-attachment mb-4">
                        <h5>Attachment</h5>
                        <a href="{{ url_for('download_attachment', filename=challenge.attachment) }}" 
                           class="btn btn-outline-primary">
                            <i class="fas fa-download me-2"></i>Download Attachment
                        </a>
                    </div>
                    {% endif %}

                    {% if solve %}
                    <!-- Solution Information (Only shown after solving) -->
                    <div class="solution-section mb-4">
                        <h5 class="text-success fw-bold"><i class="fas fa-trophy me-2"></i>Challenge Solved!</h5>
                        <div class="card border-success shadow-sm">
                            <div class="card-header bg-success bg-opacity-10">
                                <ul class="nav nav-tabs card-header-tabs nav-fill" id="solutionTabs" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link active fw-semibold" id="explanation-tab" data-bs-toggle="tab" 
                                                data-bs-target="#explanation" type="button" role="tab" 
                                                aria-controls="explanation" aria-selected="true">
                                            <i class="fas fa-lightbulb me-2"></i>Explanation
                                        </button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link fw-semibold" id="solution-tab" data-bs-toggle="tab" 
                                                data-bs-target="#solution" type="button" role="tab" 
                                                aria-controls="solution" aria-selected="false">
                                            <i class="fas fa-code me-2"></i>Solution Steps
                                        </button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link fw-semibold" id="resources-tab" data-bs-toggle="tab" 
                                                data-bs-target="#resources" type="button" role="tab" 
                                                aria-controls="resources" aria-selected="false">
                                            <i class="fas fa-book me-2"></i>Learning Resources
                                        </button>
                                    </li>
                                </ul>
                            </div>
                            <div class="card-body p-4">
                                <div class="tab-content" id="solutionTabsContent">
                                    <div class="tab-pane fade show active" id="explanation" role="tabpanel" 
                                         aria-labelledby="explanation-tab">
                                        {% if challenge.answer_explanation %}
                                            <div class="explanation-content bg-light p-3 rounded">
                                                {{ challenge.answer_explanation|nl2br|safe }}
                                            </div>
                                        {% else %}
                                            <p class="text-muted">No explanation available for this challenge.</p>
                                        {% endif %}
                                    </div>
                                    <div class="tab-pane fade" id="solution" role="tabpanel" 
                                         aria-labelledby="solution-tab">
                                        {% if challenge.solution_steps %}
                                            <div class="solution-steps bg-light p-3 rounded">
                                                {{ challenge.solution_steps|nl2br|safe }}
                                            </div>
                                        {% else %}
                                            <p class="text-muted">No solution steps available for this challenge.</p>
                                        {% endif %}
                                    </div>
                                    <div class="tab-pane fade" id="resources" role="tabpanel" 
                                         aria-labelledby="resources-tab">
                                        <div class="resources-content bg-light p-3 rounded">
                                            <h6 class="fw-bold mb-3">Learn More About This Topic:</h6>
                                            <ul class="resource-links">
                                                {% if challenge.category == 'Web' %}
                                                    <li><a href="https://owasp.org/www-project-top-ten/" target="_blank" class="btn btn-outline-primary btn-sm mb-2">OWASP Top 10</a></li>
                                                    <li><a href="https://portswigger.net/web-security" target="_blank" class="btn btn-outline-primary btn-sm mb-2">PortSwigger Web Security Academy</a></li>
                                                {% elif challenge.category == 'Crypto' %}
                                                    <li><a href="https://cryptohack.org/" target="_blank" class="btn btn-outline-primary btn-sm mb-2">CryptoHack</a></li>
                                                    <li><a href="https://www.cryptool.org/" target="_blank" class="btn btn-outline-primary btn-sm mb-2">CrypTool</a></li>
                                                {% elif challenge.category == 'Forensics' %}
                                                    <li><a href="https://www.sans.org/digital-forensics/" target="_blank" class="btn btn-outline-primary btn-sm mb-2">SANS Digital Forensics</a></li>
                                                    <li><a href="https://forensicscontest.com/" target="_blank" class="btn btn-outline-primary btn-sm mb-2">Forensics Contest</a></li>
                                                {% elif challenge.category == 'Reverse Engineering' %}
                                                    <li><a href="https://beginners.re/" target="_blank" class="btn btn-outline-primary btn-sm mb-2">Reverse Engineering for Beginners</a></li>
                                                    <li><a href="https://challenges.re/" target="_blank" class="btn btn-outline-primary btn-sm mb-2">Reverse Engineering Challenges</a></li>
                                                {% elif challenge.category == 'Pwn' or challenge.category == 'Binary' %}
                                                    <li><a href="https://pwnable.tw/" target="_blank" class="btn btn-outline-primary btn-sm mb-2">Pwnable.tw</a></li>
                                                    <li><a href="https://exploit.education/" target="_blank" class="btn btn-outline-primary btn-sm mb-2">Exploit Education</a></li>
                                                {% elif challenge.category == 'OSINT' %}
                                                    <li><a href="https://osintframework.com/" target="_blank" class="btn btn-outline-primary btn-sm mb-2">OSINT Framework</a></li>
                                                    <li><a href="https://www.bellingcat.com/resources/" target="_blank" class="btn btn-outline-primary btn-sm mb-2">Bellingcat's OSINT Resources</a></li>
                                                {% elif challenge.category == 'Mobile' %}
                                                    <li><a href="https://mobile-security.gitbook.io/" target="_blank" class="btn btn-outline-primary btn-sm mb-2">Mobile Security Testing Guide</a></li>
                                                    <li><a href="https://github.com/OWASP/owasp-mstg" target="_blank" class="btn btn-outline-primary btn-sm mb-2">OWASP Mobile Security Testing Guide</a></li>
                                                {% else %}
                                                    <li><a href="https://tryhackme.com/" target="_blank" class="btn btn-outline-primary btn-sm mb-2">TryHackMe</a></li>
                                                    <li><a href="https://www.hackthebox.com/" target="_blank" class="btn btn-outline-primary btn-sm mb-2">HackTheBox</a></li>
                                                {% endif %}
                                                <li><a href="https://ctftime.org/" target="_blank" class="btn btn-outline-primary btn-sm mb-2">CTFtime - Find more CTF competitions</a></li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <!-- Flag Submission -->
                    <div class="flag-submission mb-4">
                        <h5 class="text-warning fw-bold"><i class="fas fa-flag me-2"></i>Submit Flag</h5>
                        <div class="card border-warning shadow-sm">
                            <div class="card-body p-3">
                                <form id="flagForm" class="mb-2">
                                    <div class="input-group input-group-lg">
                                        <span class="input-group-text bg-light"><i class="fas fa-key"></i></span>
                                        <input type="text" class="form-control" id="flagInput" 
                                               placeholder="Enter flag (format: flag{...})" required>
                                        <button class="btn btn-warning fw-bold" type="submit">
                                            <i class="fas fa-paper-plane me-2"></i>Submit
                                        </button>
                                    </div>
                                    <div class="form-text text-muted mt-2">
                                        <i class="fas fa-info-circle me-1"></i> Flags are usually in the format: flag{...} or CTF{...}
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Hints -->
                    {% if hints %}
                    <div class="hints-section mb-4">
                        <h5 class="text-info fw-bold"><i class="fas fa-lightbulb me-2"></i>Hints</h5>
                        <div class="card border-info shadow-sm">
                            <div class="card-body p-3">
                                <div class="hints-list">
                                    {% for hint in hints %}
                                    <div class="hint-item mb-3 p-3 rounded{% if hint.id in revealed_hints %} bg-info bg-opacity-10{% else %} bg-light{% endif %}">
                                        {% if hint.id in revealed_hints %}
                                        <div class="hint-content">
                                            <div class="d-flex align-items-center mb-2">
                                                <i class="fas fa-lightbulb text-info me-2 fs-5"></i>
                                                <h6 class="mb-0 fw-bold">Hint {{ hint.display_order }}</h6>
                                            </div>
                                            <div class="ps-4 border-start border-info">
                                                {{ hint.content }}
                                            </div>
                                        </div>
                                        {% else %}
                                        <div class="hint-locked d-flex justify-content-between align-items-center">
                                            <div>
                                                <i class="fas fa-lock text-secondary me-2"></i>
                                                <span class="fw-semibold">Hint {{ hint.display_order }}</span>
                                            </div>
                                            <button class="btn btn-info" 
                                                    onclick="purchaseHint({{ hint.id }})">
                                                <i class="fas fa-unlock me-2"></i>Reveal ({{ hint.cost }} pts)
                                            </button>
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Recent Submissions -->
                    {% if recent_submissions %}
                    <div class="submissions-section mb-4">
                        <h5 class="text-secondary fw-bold"><i class="fas fa-history me-2"></i>Recent Submissions</h5>
                        <div class="card border-secondary shadow-sm">
                            <div class="card-body p-3">
                                <div class="submissions-list">
                                    {% for submission in recent_submissions %}
                                    <div class="submission-item mb-2 p-2 rounded bg-light">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <i class="fas fa-{{ 'check-circle text-success' if submission.is_correct else 'times-circle text-danger' }} me-2"></i>
                                                <span class="submission-flag font-monospace">{{ submission.submitted_flag[:10] }}...</span>
                                            </div>
                                            <div>
                                                <span class="badge bg-{{ 'success' if submission.is_correct else 'danger' }} me-2">
                                                    {{ 'Correct' if submission.is_correct else 'Incorrect' }}
                                                </span>
                                                <small class="text-muted"><i class="fas fa-clock me-1"></i>{{ submission.submitted_at.strftime('%H:%M') }}</small>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        
        <!-- Challenge Details Sidebar -->
        <div class="col-lg-4">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Challenge Details
                    </h5>
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-tag me-2"></i>Category:</span>
                            <span class="badge bg-secondary">{{ challenge.category }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-signal me-2"></i>Difficulty:</span>
                            <span class="badge bg-{{ 'success' if challenge.difficulty == 'easy' else 'warning' if challenge.difficulty == 'medium' else 'danger' }}">{{ challenge.difficulty|capitalize }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-star me-2"></i>Points:</span>
                            <span class="badge bg-primary">{{ challenge.points }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-trophy me-2"></i>Solves:</span>
                            <span class="badge bg-info">{{ challenge.solves|length }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-calendar-alt me-2"></i>Added:</span>
                            <span class="text-muted">{{ challenge.created_at.strftime('%Y-%m-%d') }}</span>
                        </li>
                    </ul>
                </div>
            </div>
            
            <!-- Top Solvers Card -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-trophy me-2"></i>
                        Top Solvers
                    </h5>
                </div>
                <div class="card-body p-0">
                    <ul class="list-group list-group-flush">
                        {% for solve in challenge.solves[:5] %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <span class="badge bg-secondary me-2">{{ loop.index }}</span>
                                <span>{{ solve.user.username }}</span>
                            </div>
                            <small class="text-muted">{{ solve.solved_at.strftime('%Y-%m-%d %H:%M') }}</small>
                        </li>
                        {% else %}
                        <li class="list-group-item text-center text-muted">
                            <i class="fas fa-ghost me-2"></i>No solves yet. Be the first!
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            <div class="card shadow-sm mb-4">
                <div class="card-body d-flex justify-content-between">
                    {% if prev_challenge %}
                    <a href="{{ url_for('challenge_detail', challenge_id=prev_challenge.id) }}" class="btn btn-outline-primary">
                        <i class="fas fa-arrow-left"></i> Previous
                    </a>
                    {% else %}
                    <span></span>
                    {% endif %}
                    {% if next_challenge %}
                    <a href="{{ url_for('challenge_detail', challenge_id=next_challenge.id) }}" class="btn btn-primary">
                        Next <i class="fas fa-arrow-right"></i>
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Challenge-specific JavaScript -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Flag submission handling
        const flagForm = document.getElementById('flagForm');
        if (flagForm) {
            flagForm.addEventListener('submit', function(e) {
                e.preventDefault();
                submitFlag();
            });
        }
    });
</script>
{% endblock %}

{% block extra_css %}
<style>
.challenge-meta .badge {
    font-size: 0.875rem;
}

.hint-item {
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 1rem;
    background: #f8f9fa;
}

.hint-content {
    color: #495057;
}

.hint-locked {
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.submission-item {
    border: 1px solid #e9ecef;
    border-radius: 6px;
    padding: 0.75rem;
    background: white;
}

.submission-flag {
    font-family: monospace;
    color: #6c757d;
}

/* Solution Section Styles */
.solution-section {
    margin-top: 1.5rem;
}

.solution-section .card {
    border: none;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.solution-section .card-header {
    background-color: #f8f9fa;
    border-bottom: none;
    padding: 0.75rem 1rem 0;
}

.solution-section .nav-tabs .nav-link {
    color: #495057;
    border: none;
    padding: 0.75rem 1rem;
    font-size: 0.9rem;
    font-weight: 500;
    border-radius: 0;
}

.solution-section .nav-tabs .nav-link.active {
    color: #007bff;
    background-color: transparent;
    border-bottom: 2px solid #007bff;
}

.solution-section .tab-content {
    padding: 1rem 0;
}

.explanation-content, .solution-steps {
    line-height: 1.6;
    color: #343a40;
}

.explanation-content h1, .explanation-content h2, .explanation-content h3,
.solution-steps h1, .solution-steps h2, .solution-steps h3 {
    font-size: 1.25rem;
    margin-top: 1.5rem;
    margin-bottom: 0.75rem;
    color: #212529;
}

.explanation-content pre, .solution-steps pre {
    background-color: #f8f9fa;
    padding: 1rem;
    border-radius: 0.25rem;
    margin: 1rem 0;
    overflow-x: auto;
}

.explanation-content code, .solution-steps code {
    background-color: #f8f9fa;
    padding: 0.2rem 0.4rem;
    border-radius: 0.2rem;
    font-size: 0.875rem;
    color: #e83e8c;
}

.resource-links {
    list-style-type: none;
    padding-left: 0;
}

.resource-links li {
    margin-bottom: 0.75rem;
}

.resource-links a {
    display: inline-block;
    color: #007bff;
    text-decoration: none;
    padding: 0.5rem 0.75rem;
    background-color: #f8f9fa;
    border-radius: 0.25rem;
    transition: all 0.2s ease;
    font-size: 0.9rem;
}

.resource-links a:hover {
    background-color: #e9ecef;
    color: #0056b3;
    transform: translateY(-2px);
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

/* Challenge Chat Styles */
.chat-container-challenge {
    height: 500px;
    display: flex;
    flex-direction: column;
    background: #f8f9fa;
}

.chat-tabs-challenge {
    display: flex;
    border-bottom: 1px solid #dee2e6;
    background: white;
}

.tab-btn-challenge {
    flex: 1;
    padding: 0.75rem;
    background: none;
    border: none;
    color: #6c757d;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.875rem;
    font-weight: 500;
}

.tab-btn-challenge:hover {
    background: #e9ecef;
    color: #495057;
}

.tab-btn-challenge.active {
    background: #007bff;
    color: white;
}

.tab-btn-challenge i {
    margin-right: 0.5rem;
}

.chat-rooms-challenge {
    flex: 1;
    overflow: hidden;
}

.chat-room-challenge {
    display: none;
    flex-direction: column;
    height: 100%;
}

.chat-room-challenge.active {
    display: flex;
}

.messages-container-challenge {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
    background: white;
}

.message-input-challenge {
    padding: 0.75rem;
    border-top: 1px solid #dee2e6;
    background: white;
    display: flex;
    gap: 0.5rem;
}

.message-input-challenge input {
    flex: 1;
    padding: 0.5rem 0.75rem;
    border: 1px solid #ced4da;
    border-radius: 20px;
    font-size: 0.875rem;
}

.message-input-challenge input:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

.message-input-challenge button {
    background: #007bff;
    border: none;
    color: white;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
}

.message-input-challenge button:hover {
    background: #0056b3;
    transform: scale(1.05);
}

.friends-list-challenge {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
}

.friend-item-challenge {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-bottom: 0.5rem;
}

.friend-item-challenge:hover {
    background: #e9ecef;
}

.friend-pic-challenge {
    position: relative;
    width: 40px;
    height: 40px;
}

.friend-pic-challenge img {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
}

.online-status-challenge {
    position: absolute;
    bottom: 2px;
    right: 2px;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    border: 2px solid white;
}

.online-status-challenge.online {
    background: #28a745;
}

.online-status-challenge.offline {
    background: #6c757d;
}

.friend-info-challenge h6 {
    margin: 0;
    font-size: 0.875rem;
    font-weight: 500;
    color: #495057;
}

.friend-info-challenge .status {
    color: #6c757d;
    font-size: 0.75rem;
}

.no-friends-challenge {
    text-align: center;
    padding: 2rem;
    color: #6c757d;
}

.no-friends-challenge i {
    font-size: 2rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

.no-friends-challenge p {
    margin-bottom: 1rem;
    font-size: 0.875rem;
}

/* Message Styles */
.message-challenge {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 0.75rem;
    animation: messageSlideIn 0.3s ease-out;
}

@keyframes messageSlideIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.message-challenge.own-message {
    flex-direction: row-reverse;
}

.message-avatar-challenge {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    overflow: hidden;
    flex-shrink: 0;
}

.message-avatar-challenge img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.message-content-challenge {
    flex: 1;
    max-width: 80%;
}

.message-header-challenge {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.25rem;
}

.message-username-challenge {
    font-weight: 600;
    color: #495057;
    font-size: 0.75rem;
}

.message-time-challenge {
    font-size: 0.625rem;
    color: #6c757d;
}

.message-text-challenge {
    background: #e9ecef;
    padding: 0.5rem 0.75rem;
    border-radius: 12px;
    color: #495057;
    line-height: 1.4;
    word-wrap: break-word;
    font-size: 0.875rem;
}

.own-message .message-text-challenge {
    background: #007bff;
    color: white;
}

/* Responsive Design */
@media (max-width: 768px) {
    .chat-container-challenge {
        height: 400px;
    }
    
    .tab-btn-challenge {
        font-size: 0.75rem;
        padding: 0.5rem;
    }
    
    .tab-btn-challenge i {
        margin-right: 0.25rem;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.js"></script>
<script>
let socket;
let currentRoom = 'general';
let currentPrivateChat = null;

// Initialize Socket.IO
document.addEventListener('DOMContentLoaded', function() {
    socket = io();
    
    socket.on('connect', function() {
        console.log('Connected to chat server');
        joinRoom('general');
    });
    
    socket.on('new_message', function(data) {
        addMessage(data);
    });
    
    // Load initial messages
    loadMessages('general');
    
    // Setup event listeners
    setupChatEventListeners();
});

function setupChatEventListeners() {
    // Tab switching
    document.querySelectorAll('.tab-btn-challenge').forEach(btn => {
        btn.addEventListener('click', function() {
            const tab = this.dataset.tab;
            switchTab(tab);
        });
    });
    
    // Message sending
    document.getElementById('general-send-challenge').addEventListener('click', function() {
        sendMessage('general');
    });
    
    document.getElementById('general-input-challenge').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage('general');
        }
    });
    
    {% if user_team %}
    document.getElementById('team-send-challenge').addEventListener('click', function() {
        sendMessage('team');
    });
    
    document.getElementById('team-input-challenge').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage('team');
        }
    });
    {% endif %}
}

function switchTab(tab) {
    // Update active tab
    document.querySelectorAll('.tab-btn-challenge').forEach(btn => btn.classList.remove('active'));
    document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
    
    // Update active room
    document.querySelectorAll('.chat-room-challenge').forEach(room => room.classList.remove('active'));
    document.getElementById(`${tab}-chat-challenge`).classList.add('active');
    
    // Update current room
    if (tab === 'general') {
        currentRoom = 'general';
        loadMessages('general');
    } else if (tab === 'team') {
        currentRoom = 'team-{{ user_team.id if user_team else "" }}';
        loadMessages(currentRoom);
    } else if (tab === 'friends') {
        // Friends tab doesn't have a main chat area
        return;
    }
    
    joinRoom(currentRoom);
}

function joinRoom(room) {
    if (socket) {
        socket.emit('join_chat', { room: room });
    }
}

function loadMessages(room) {
    fetch(`/api/chat/messages?room=${room}&limit=30`)
        .then(response => response.json())
        .then(messages => {
            const messagesContainer = document.getElementById(`${room.split('-')[0]}-messages-challenge`);
            if (messagesContainer) {
                messagesContainer.innerHTML = '';
                messages.forEach(message => addMessage(message));
                scrollToBottom(messagesContainer);
            }
        })
        .catch(error => console.error('Error loading messages:', error));
}

function addMessage(message) {
    const room = message.room || currentRoom;
    const roomType = room.split('-')[0];
    const messagesContainer = document.getElementById(`${roomType}-messages-challenge`);
    
    if (!messagesContainer) return;
    
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message-challenge';
    
    const isOwnMessage = message.user_id === {{ current_user.id }};
    messageDiv.classList.add(isOwnMessage ? 'own-message' : 'other-message');
    
    const profilePic = message.user_avatar || '/static/images/default-avatar.svg';
    
    messageDiv.innerHTML = `
        <div class="message-avatar-challenge">
            <img src="${profilePic}" alt="${message.username}">
        </div>
        <div class="message-content-challenge">
            <div class="message-header-challenge">
                <span class="message-username-challenge">${message.username}</span>
                <span class="message-time-challenge">${formatTime(message.created_at)}</span>
            </div>
            <div class="message-text-challenge">${message.content}</div>
        </div>
    `;
    
    messagesContainer.appendChild(messageDiv);
    scrollToBottom(messagesContainer);
}

function sendMessage(roomType) {
    const input = document.getElementById(`${roomType}-input-challenge`);
    const message = input.value.trim();
    
    if (!message) return;
    
    const room = roomType === 'team' ? 'team-{{ user_team.id if user_team else "" }}' : roomType;
    
    const data = {
        content: message,
        room: room
    };
    
    fetch('/api/chat/send', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.error) {
            console.error('Error sending message:', result.error);
        } else {
            input.value = '';
            // Message will be added via socket.io
        }
    })
    .catch(error => console.error('Error:', error));
}

function openPrivateChatChallenge(friendId, friendName) {
    const room = `private-${friendId}`;
    currentRoom = room;
    currentPrivateChat = friendId;
    
    // Create or show private chat window
    let privateChatWindow = document.getElementById(`private-chat-${friendId}`);
    if (!privateChatWindow) {
        createPrivateChatWindow(friendId, friendName);
    } else {
        privateChatWindow.style.display = 'block';
    }
    
    // Load messages
    loadPrivateMessages(room, friendId);
    joinRoom(room);
}

function createPrivateChatWindow(friendId, friendName) {
    const privateChatsContainer = document.getElementById('private-chats-challenge');
    
    const chatWindow = document.createElement('div');
    chatWindow.id = `private-chat-${friendId}`;
    chatWindow.className = 'private-chat-window';
    chatWindow.innerHTML = `
        <div class="private-chat-header">
            <h6>Chat with ${friendName}</h6>
            <button class="close-chat-btn" onclick="closePrivateChat(${friendId})">&times;</button>
        </div>
        <div class="private-messages" id="private-messages-${friendId}"></div>
        <div class="private-input">
            <input type="text" id="private-input-${friendId}" placeholder="Type your message...">
            <button onclick="sendPrivateMessage(${friendId})"><i class="fas fa-paper-plane"></i></button>
        </div>
    `;
    
    privateChatsContainer.appendChild(chatWindow);
    
    // Setup input event listener
    document.getElementById(`private-input-${friendId}`).addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendPrivateMessage(friendId);
        }
    });
}

function loadPrivateMessages(room, friendId) {
    fetch(`/api/chat/messages?room=${room}&limit=30`)
        .then(response => response.json())
        .then(messages => {
            const messagesContainer = document.getElementById(`private-messages-${friendId}`);
            if (messagesContainer) {
                messagesContainer.innerHTML = '';
                messages.forEach(message => addPrivateMessage(message, friendId));
                scrollToBottom(messagesContainer);
            }
        })
        .catch(error => console.error('Error loading private messages:', error));
}

function addPrivateMessage(message, friendId) {
    const messagesContainer = document.getElementById(`private-messages-${friendId}`);
    if (!messagesContainer) return;
    
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message-challenge';
    
    const isOwnMessage = message.user_id === {{ current_user.id }};
    messageDiv.classList.add(isOwnMessage ? 'own-message' : 'other-message');
    
    const profilePic = message.user_avatar || '/static/images/default-avatar.svg';
    
    messageDiv.innerHTML = `
        <div class="message-avatar-challenge">
            <img src="${profilePic}" alt="${message.username}">
        </div>
        <div class="message-content-challenge">
            <div class="message-header-challenge">
                <span class="message-username-challenge">${message.username}</span>
                <span class="message-time-challenge">${formatTime(message.created_at)}</span>
            </div>
            <div class="message-text-challenge">${message.content}</div>
        </div>
    `;
    
    messagesContainer.appendChild(messageDiv);
    scrollToBottom(messagesContainer);
}

function sendPrivateMessage(friendId) {
    const input = document.getElementById(`private-input-${friendId}`);
    const message = input.value.trim();
    
    if (!message) return;
    
    const room = `private-${friendId}`;
    
    const data = {
        content: message,
        room: room
    };
    
    fetch('/api/chat/send', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.error) {
            console.error('Error sending message:', result.error);
        } else {
            input.value = '';
            // Message will be added via socket.io
        }
    })
    .catch(error => console.error('Error:', error));
}

function closePrivateChat(friendId) {
    const chatWindow = document.getElementById(`private-chat-${friendId}`);
    if (chatWindow) {
        chatWindow.style.display = 'none';
    }
}

function formatTime(timestamp) {
    const date = new Date(timestamp);
    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

function scrollToBottom(container) {
    container.scrollTop = container.scrollHeight;
}

// Flag submission helper
function submitFlag() {
    const flag = document.getElementById('flagInput').value.trim();
    if (!flag) {
        showAlert('danger', 'Please enter a flag');
        return;
    }

    fetch('/submit_flag', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            challenge_id: {{ challenge.id }},
            flag: flag
        })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showAlert('success', 'Flag submitted successfully!');
            document.getElementById('flagInput').value = '';
            setTimeout(() => location.reload(), 1200);
        } else {
            showAlert('danger', result.message || 'Incorrect flag');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('danger', 'Error submitting flag');
    });
}

function purchaseHint(hintId) {
    if (!confirm('Are you sure you want to purchase this hint?')) {
        return;
    }
    
    fetch('/purchase_hint', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            hint_id: hintId
        })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showAlert('success', 'Hint purchased successfully!');
            // Reload page to show hint
            setTimeout(() => location.reload(), 1500);
        } else {
            showAlert('danger', result.message || 'Error purchasing hint');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('danger', 'Error purchasing hint');
    });
}

function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}
</script>

<style>
/* Private Chat Window Styles */
.private-chats-challenge {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1000;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.private-chat-window {
    width: 300px;
    height: 400px;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    display: flex;
    flex-direction: column;
}

.private-chat-header {
    background: #007bff;
    color: white;
    padding: 0.75rem;
    border-radius: 8px 8px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.private-chat-header h6 {
    margin: 0;
    font-size: 0.875rem;
}

.close-chat-btn {
    background: none;
    border: none;
    color: white;
    font-size: 1.25rem;
    cursor: pointer;
    padding: 0;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.3s ease;
}

.close-chat-btn:hover {
    background: rgba(255, 255, 255, 0.2);
}

.private-messages {
    flex: 1;
    overflow-y: auto;
    padding: 0.75rem;
    background: #f8f9fa;
}

.private-input {
    padding: 0.75rem;
    border-top: 1px solid #dee2e6;
    background: white;
    border-radius: 0 0 8px 8px;
    display: flex;
    gap: 0.5rem;
}

.private-input input {
    flex: 1;
    padding: 0.5rem 0.75rem;
    border: 1px solid #ced4da;
    border-radius: 20px;
    font-size: 0.875rem;
}

.private-input input:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

.private-input button {
    background: #007bff;
    border: none;
    color: white;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
}

.private-input button:hover {
    background: #0056b3;
    transform: scale(1.05);
}
</style>
{% endblock %}
