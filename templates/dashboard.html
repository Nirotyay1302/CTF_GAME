{% extends "base.html" %}

{% block title %}Dashboard - HUNTING-CTF{% endblock %}

{% block extra_css %}
<style>
  /* Improve readability and contrast */
  .dash-hero {
    background: linear-gradient(135deg, rgba(99,102,241,.22), rgba(139,92,246,.22));
    border: 1px solid var(--dark-border);
    border-radius: 16px;
    padding: 1.5rem;
  }
  .avatar-xl { width: 80px; height: 80px; object-fit: cover; border: 3px solid rgba(255,255,255,.35); }
  .stat-card { background: rgba(30,41,59,.85); border: 1px solid var(--dark-border); border-radius: 12px; transition: .2s; }
  .stat-card:hover { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(0,0,0,.28); }
  .stat-icon { font-size: 1.6rem; opacity: .95 }
  .stat-value { font-weight: 800; font-size: 1.8rem; letter-spacing: .2px; color: #fff; }
  .section-card { background: rgba(30,41,59,.85); border: 1px solid var(--dark-border); border-radius: 14px; color: #e6ebf3; }

  /* Softer muted text for dark bg */
  .section-card .text-muted, .dash-hero .text-muted, .stat-card .text-muted { color: #c7d2e0 !important; }

  .badge-soft { background: rgba(99,102,241,.15); color: #c7d2fe; border: 1px solid rgba(99,102,241,.25) }
  .category-pill { background: rgba(148,163,184,.12); border: 1px solid var(--dark-border); color: #e6ebf3; }

  .empty-state i { font-size: 2.25rem; opacity: .7; color: #c7d2e0; }
  .quick-link { display: inline-flex; align-items: center; gap: .5rem; border: 1px solid var(--dark-border); border-radius: 10px; padding: .6rem .9rem; text-decoration: none }
  .quick-link:hover { background: rgba(148,163,184,.08) }

  .list-clean .list-group-item { background: transparent; border-color: var(--dark-border) }
  .list-clean .fw-semibold { color: #f8fafc; }

  .progress { background: rgba(148,163,184,.15); height: 8px; }
  .progress-bar { background: linear-gradient(90deg, #6366f1, #8b5cf6); }
</style>
{% endblock %}

{% block content %}
<div class="dash-hero mb-4">
  <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
    <div class="d-flex align-items-center gap-3">
      {% if user.profile_picture %}
        <img class="rounded-circle avatar-xl" src="{{ url_for('profile_picture', filename=user.profile_picture) }}" alt="Profile"
             onerror="this.onerror=null; this.src='{{ url_for('static', filename='images/default-avatar.svg') }}';">
      {% else %}
        <img class="rounded-circle avatar-xl" src="{{ url_for('static', filename='images/default-avatar.svg') }}" alt="Profile">
      {% endif %}
      <div>
        <h2 class="mb-1 text-white">Welcome back, {{ user.username }}!</h2>
        <div class="text-muted">Stay sharp. New flags await.</div>
        {% if user.first_name or user.last_name %}
          <div class="text-muted small">{{ user.first_name }} {{ user.last_name }}</div>
        {% endif %}
      </div>
    </div>
    <div class="d-flex flex-wrap gap-2">
      <a class="quick-link text-light" href="{{ url_for('challenges') }}"><i class="fas fa-puzzle-piece"></i> Browse Challenges</a>
      <a class="quick-link text-light" href="{{ url_for('scoreboard') }}"><i class="fas fa-trophy"></i> Leaderboard</a>
      <a class="quick-link text-light" href="{{ url_for('teams') }}"><i class="fas fa-users"></i> Teams</a>
      <a class="quick-link text-light" href="{{ url_for('profile') }}"><i class="fas fa-user"></i> Edit Profile</a>
    </div>
  </div>
</div>

<!-- Stats -->
<div class="row g-3 mb-4">
  <div class="col-6 col-md-3">
    <div class="stat-card p-3 h-100">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div class="text-muted">Total Points</div>
        <i class="fas fa-trophy stat-icon text-warning"></i>
      </div>
      <div class="stat-value">{{ user_score }}</div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="stat-card p-3 h-100">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div class="text-muted">Challenges Solved</div>
        <i class="fas fa-check-circle stat-icon text-success"></i>
      </div>
      <div class="stat-value">{{ user_solves }}</div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="stat-card p-3 h-100">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div class="text-muted">Current Rank</div>
        <i class="fas fa-medal stat-icon text-info"></i>
      </div>
      <div class="stat-value">#{{ user_rank }}</div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="stat-card p-3 h-100">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div class="text-muted">Notifications</div>
        <i class="fas fa-bell stat-icon text-primary"></i>
      </div>
      <div class="stat-value">{{ notifications|length }}</div>
    </div>
  </div>
</div>

<!-- Main Content: Recent Activity + Right Column -->
<div class="row g-3">
  <!-- Recent Activity -->
  <div class="col-lg-8">
    <div class="section-card">
      <div class="p-3 border-bottom border-dark"><h5 class="mb-0 text-white"><i class="fas fa-clock"></i> Recent Activity</h5></div>
      <div class="p-3">
        {% if recent_solves %}
        <div class="list-group list-clean">
          {% for solve, challenge in recent_solves %}
          <div class="list-group-item">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
              <div>
                <div class="fw-semibold"><i class="fas fa-check text-success"></i> {{ challenge.title }}</div>
                <div class="text-muted small">
                  <i class="fas fa-tag"></i> {{ challenge.category or 'Misc' }} •
                  <i class="fas fa-signal"></i> {{ challenge.difficulty|title }} •
                  <i class="fas fa-calendar"></i> {{ solve.solved_at.strftime('%b %d, %Y %I:%M %p') }}
                </div>
              </div>
              <div class="badge badge-soft">+{{ challenge.points }} pts</div>
            </div>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <div class="empty-state text-center py-4">
          <i class="fas fa-puzzle-piece mb-2"></i>
          <div class="text-muted mb-2">No solves yet. Start your first challenge!</div>
          <a class="btn btn-primary" href="{{ url_for('challenges') }}"><i class="fas fa-play"></i> Start Solving</a>
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Your Team -->
    <div class="section-card mb-3 mt-3">
      <div class="p-3 border-bottom border-dark"><h5 class="mb-0 text-white"><i class="fas fa-users"></i> Your Team</h5></div>
      <div class="p-3">
        {% if user.team_membership %}
          {% set team = user.team_membership.team %}
          <div class="d-flex align-items-center justify-content-between mb-2">
            <div class="fw-semibold text-white">{{ team.name }}</div>
            <span class="badge badge-soft"><i class="fas fa-hashtag"></i> {{ team.team_code }}</span>
          </div>
          <div class="text-muted small mb-2">Members:</div>
          <div class="d-flex flex-wrap gap-1">
            {% for member in team.memberships %}
              <span class="category-pill px-2 py-1 rounded small">{{ member.user.username }}</span>
            {% endfor %}
          </div>
        {% else %}
          <div class="text-muted">You're not in a team yet.</div>
          <div class="d-grid gap-2 mt-2">
            <a href="{{ url_for('teams') }}" class="btn btn-outline-primary btn-sm"><i class="fas fa-users"></i> Create or Join Team</a>
          </div>
        {% endif %}
      </div>
    </div>

    <!-- Notifications -->
    <div class="section-card mt-3">
      <div class="p-3 border-bottom border-dark"><h5 class="mb-0 text-white"><i class="fas fa-bell"></i> Notifications</h5></div>
      <div class="p-3">
        {% if notifications %}
          <div class="d-flex flex-column gap-2">
            {% for n in notifications %}
            <div class="border rounded p-2" style="border-color: var(--dark-border);">
              <div class="fw-semibold text-white">{{ n.title }}</div>
              <div class="text-muted small">{{ n.message }}</div>
            </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="text-muted">No new notifications.</div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Right Column -->
  <div class="col-lg-4">
    <!-- Category Breakdown -->
    <div class="section-card mb-3">
      <div class="p-3 border-bottom border-dark"><h5 class="mb-0 text-white"><i class="fas fa-layer-group"></i> Category Breakdown</h5></div>
      <div class="p-3">
        <div class="d-flex flex-column gap-2">
          {% for cat, items in challenges_by_category.items() %}
            {% set solved_in_cat = (items|selectattr('solved')|list|length) %}
            {% set total_in_cat = items|length %}
            {% set p = (solved_in_cat / total_in_cat * 100) if total_in_cat>0 else 0 %}
            <div>
              <div class="d-flex justify-content-between small mb-1">
                <span class="category-pill px-2 py-1 rounded">{{ cat }}</span>
                <span class="text-muted">{{ solved_in_cat }}/{{ total_in_cat }}</span>
              </div>
              <div class="progress">
                <div class="progress-bar" style="width: {{ p }}%"></div>
              </div>
            </div>
          {% else %}
            <div class="text-muted">No categories yet.</div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="section-card mb-3">
      <div class="p-3 border-bottom border-dark"><h5 class="mb-0 text-white"><i class="fas fa-bolt"></i> Quick Actions</h5></div>
      <div class="p-3 d-grid gap-2">
        <a href="{{ url_for('challenges') }}" class="btn btn-primary"><i class="fas fa-puzzle-piece"></i> Explore Challenges</a>
        <a href="{{ url_for('scoreboard') }}" class="btn btn-outline-primary"><i class="fas fa-trophy"></i> View Leaderboard</a>
        <a href="{{ url_for('teams') }}" class="btn btn-outline-primary"><i class="fas fa-users"></i> Team Hub</a>
        <a href="{{ url_for('profile') }}" class="btn btn-outline-primary"><i class="fas fa-user"></i> Edit Profile</a>
      </div>
    </div>

    
      </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  // Smooth count animation for numeric stats
  document.addEventListener('DOMContentLoaded', function() {
    const counters = document.querySelectorAll('.stat-value');
    counters.forEach(function(el){
      const isNum = /^#?[0-9]+$/.test(el.textContent.replace(/\s/g, '')) || /[0-9]/.test(el.textContent);
      if(!isNum) return;
      const original = el.textContent;
      const target = parseInt(original.replace(/[^0-9]/g, '')) || 0;
      let current = 0; const steps = 30; const inc = Math.max(1, Math.ceil(target/steps));
      const timer = setInterval(()=>{
        current += inc; if(current >= target){ current = target; clearInterval(timer); }
        el.textContent = original.replace(/[0-9]+/, current);
      }, 30);
    });
  });
</script>
{% endblock %}