<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - CTF Game</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='theme.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='profile.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <div class="profile-header">
            <div class="header-left">
                <div class="avatar-wrap">
                    {% if user.profile_picture %}
                        <img src="{{ url_for('profile_picture', filename=user.profile_picture) }}" alt="Profile Picture">
                    {% else %}
                        <div class="avatar-fallback"><i class="fas fa-user"></i></div>
                    {% endif %}
                </div>
                <div class="header-meta">
                    <h1>{{ user.first_name or user.username }} {{ user.last_name or '' }}</h1>
                    <p>@{{ user.username }} Â· {{ user.email }}</p>
                </div>
            </div>
            <div class="header-right">
                <a href="{{ url_for('dashboard_enhanced') }}" class="back-btn">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </a>
            </div>
        </div>

        <div class="profile-grid">
            <div class="left-column">
                <div class="stats-card">
                    <div class="stat">
                        <div class="stat-label">Score</div>
                        <div class="stat-value">{{ user.score }}</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">Solves</div>
                        <div class="stat-value">{{ solves_count }}</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">Current Streak</div>
                        <div class="stat-value">{{ user.current_streak }}</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">Longest Streak</div>
                        <div class="stat-value">{{ user.longest_streak }}</div>
                    </div>
                </div>

                <div class="about-card">
                    <h3><i class="fas fa-id-card"></i> About</h3>
                    <ul class="about-list">
                        <li><span>Full Name</span><strong>{{ (user.first_name or '-') ~ ' ' ~ (user.last_name or '') }}</strong></li>
                        <li><span>Date of Birth</span><strong>{{ user.date_of_birth.strftime('%Y-%m-%d') if user.date_of_birth else '-' }}</strong></li>
                        <li><span>Gender</span><strong>{{ user.gender or '-' }}</strong></li>
                        <li><span>Country</span><strong>{{ user.country or '-' }}</strong></li>
                        <li><span>Timezone</span><strong>{{ user.timezone or '-' }}</strong></li>
                        <li><span>Team</span><strong>{{ team_name or 'Solo' }}{% if team_role %} ({{ team_role|title }}){% endif %}</strong></li>
                    </ul>
                </div>
            </div>

            <div class="right-column">
                <div class="profile-section">
                    <h2><i class="fas fa-user-edit"></i> Edit Profile</h2>
                    <form method="POST" enctype="multipart/form-data" class="profile-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="first_name">First Name</label>
                            <input type="text" id="first_name" name="first_name" value="{{ user.first_name or '' }}" placeholder="Enter your first name">
                        </div>
                        <div class="form-group">
                            <label for="last_name">Last Name</label>
                            <input type="text" id="last_name" name="last_name" value="{{ user.last_name or '' }}" placeholder="Enter your last name">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="date_of_birth">Date of Birth</label>
                            <input type="date" id="date_of_birth" name="date_of_birth" value="{{ user.date_of_birth.strftime('%Y-%m-%d') if user.date_of_birth else '' }}">
                        </div>
                        <div class="form-group">
                            <label for="gender">Gender</label>
                            <select id="gender" name="gender">
                                <option value="">Select gender</option>
                                <option value="male" {{ 'selected' if user.gender == 'male' else '' }}>Male</option>
                                <option value="female" {{ 'selected' if user.gender == 'female' else '' }}>Female</option>
                                <option value="other" {{ 'selected' if user.gender == 'other' else '' }}>Other</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="country">Country</label>
                            <input type="text" id="country" name="country" value="{{ user.country or '' }}" placeholder="Enter your country">
                        </div>
                        <div class="form-group">
                            <label for="timezone">Timezone</label>
                            <input type="text" id="timezone" name="timezone" value="{{ user.timezone or '' }}" placeholder="e.g., UTC+5:30">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="bio">Bio</label>
                        <textarea id="bio" name="bio" rows="4" placeholder="Tell us about yourself...">{{ user.bio or '' }}</textarea>
                    </div>

                    <div class="form-group">
                        <label for="profile_picture">Profile Picture</label>
                        {% if user.profile_picture %}
                        <div class="current-picture">
                            <img src="{{ url_for('profile_picture', filename=user.profile_picture) }}" alt="Current Profile Picture" style="max-width: 150px; max-height: 150px; border-radius: 8px; margin-bottom: 10px;">
                            <div>
                                <button type="button" onclick="deleteProfilePicture()" class="delete-picture-btn" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                    <i class="fas fa-trash"></i> Delete Picture
                                </button>
                            </div>
                        </div>
                        {% endif %}
                        <div class="file-upload-container">
                            <input type="file" id="profile_picture" name="profile_picture" accept="image/*" onchange="previewImage(this)">
                            <div class="file-upload-info">
                                <p>Supported formats: PNG, JPG, JPEG, GIF, WebP (Max 5MB)</p>
                                <p>Maximum size: 5MB</p>
                            </div>
                        </div>
                    </div>

                        <div class="form-actions">
                            <button type="submit" class="save-btn">
                                <i class="fas fa-save"></i> Save Changes
                            </button>
                            <button type="reset" class="reset-btn">
                                <i class="fas fa-undo"></i> Reset
                            </button>
                        </div>
                    </form>
                </div>

                <div class="profile-section">
                    <h2><i class="fas fa-info-circle"></i> Account Information</h2>
                    <div class="info-grid">
                        <div class="info-item"><label>Username</label><span>{{ user.username }}</span></div>
                        <div class="info-item"><label>Email</label><span>{{ user.email }}</span></div>
                        <div class="info-item"><label>Role</label><span class="role-badge {{ user.role }}">{{ user.role.title() }}</span></div>
                        <div class="info-item"><label>Team</label><span>{{ team_name or 'Solo' }}</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='theme.js') }}"></script>
    <script src="{{ url_for('static', filename='profile.js') }}"></script>

    <script>
        // Image preview functionality
        function previewImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    // Create or update preview
                    let preview = document.getElementById('image-preview');
                    if (!preview) {
                        preview = document.createElement('div');
                        preview.id = 'image-preview';
                        preview.style.marginTop = '10px';
                        input.parentNode.appendChild(preview);
                    }

                    preview.innerHTML = `
                        <img src="${e.target.result}" alt="Preview" style="max-width: 150px; max-height: 150px; border-radius: 8px; border: 2px solid #ddd;">
                        <p style="font-size: 12px; color: #666; margin-top: 5px;">Preview - Click "Save Changes" to upload</p>
                    `;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        // Delete profile picture functionality
        function deleteProfilePicture() {
            if (confirm('Are you sure you want to delete your profile picture?')) {
                fetch('/profile/picture/delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Reload the page to show changes
                        window.location.reload();
                    } else {
                        alert('Error: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error deleting profile picture');
                });
            }
        }

        // Form validation
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.querySelector('.profile-form');
            const fileInput = document.getElementById('profile_picture');

            // File size validation
            fileInput.addEventListener('change', function() {
                const file = this.files[0];
                if (file) {
                    const maxSize = 5 * 1024 * 1024; // 5MB
                    if (file.size > maxSize) {
                        alert('File too large! Please select an image smaller than 5MB.');
                        this.value = '';
                        return;
                    }

                    // Check file type
                    const allowedTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/gif', 'image/webp'];
                    if (!allowedTypes.includes(file.type)) {
                        alert('Invalid file type! Please select a PNG, JPG, JPEG, GIF, or WebP image.');
                        this.value = '';
                        return;
                    }
                }
            });

            // Show loading state on form submit
            form.addEventListener('submit', function() {
                const submitBtn = form.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                submitBtn.disabled = true;

                // Re-enable after 10 seconds as fallback
                setTimeout(() => {
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }, 10000);
            });
        });
    </script>

    {% include '_contact_footer.html' %}
</body>
</html>
