{% extends "base.html" %}

{% block title %}CTF Scoreboard - HUNTING-CTF{% endblock %}

{% block extra_css %}
<style>
    .scoreboard-hero {
        background: linear-gradient(135deg, rgba(99,102,241,.15), rgba(139,92,246,.15));
        border: 1px solid var(--dark-border);
        border-radius: 16px;
        padding: 1.75rem;
        margin-bottom: 1.5rem;
    }
    .filters-bar {
        background: rgba(30, 41, 59, 0.6);
        border: 1px solid var(--dark-border);
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    .filter-select {
        background: rgba(30, 41, 59, 0.8);
        border: 1px solid var(--dark-border);
        color: var(--text-light);
        border-radius: 8px;
        padding: .5rem .75rem;
        min-width: 180px;
    }
    .stats-overview {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 12px;
        margin: .5rem 0 1rem;
    }
    .stat-card {
        background: rgba(30, 41, 59, 0.7);
        border: 1px solid var(--dark-border);
        border-radius: 12px;
        padding: 1rem;
        text-align: center;
    }
    .stat-number { font-size: 1.75rem; font-weight: 800; color: var(--primary-color); }
    .stat-label { color: var(--text-muted); font-size: .9rem; }

    .table-wrap { border: 1px solid var(--dark-border); border-radius: 12px; overflow: hidden; }
    .scoreboard-table { width: 100%; border-collapse: collapse; }
    .scoreboard-table th { background: rgba(99,102,241,.15); color: var(--text-light); padding: .75rem; text-align: left; font-weight: 700; }
    .scoreboard-table td { padding: .75rem; border-bottom: 1px solid var(--dark-border); }
    .scoreboard-table tr:hover { background: rgba(30, 41, 59, 0.5); }
    .scoreboard-table tr.current { background: rgba(99,102,241,.1); }
    .rank, .solves, .score, .medals { text-align: center; }
    .score { color: var(--success-color); font-weight: 800; }

    .medal { font-size: 1.25rem; }
    .top1 .rank { color: #ffd700; }
    .top2 .rank { color: #c0c0c0; }
    .top3 .rank { color: #cd7f32; }

    .recent-activity { background: rgba(30,41,59,.6); border: 1px solid var(--dark-border); border-radius: 12px; padding: 1rem; }
    .activity-item { display: flex; justify-content: space-between; padding: .5rem 0; border-bottom: 1px solid var(--dark-border); }
    .activity-item:last-child { border-bottom: none; }
    .activity-time { color: var(--text-muted); font-size: .85rem; }
</style>
{% endblock %}

{% block content %}
<div class="scoreboard-hero">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3">
        <div>
            <h2 class="mb-1"><i class="fas fa-trophy me-2"></i>CTF Scoreboard</h2>
            <div class="text-muted">Current rankings and statistics</div>
        </div>
        <div class="d-flex gap-2">
            <a href="{{ url_for('team_scoreboard') }}" class="btn btn-primary"><i class="fas fa-users me-1"></i>Team Rankings</a>
            <a href="{{ url_for('dashboard') }}" class="btn btn-outline-primary"><i class="fas fa-arrow-left me-1"></i>Back to Dashboard</a>
        </div>
    </div>

    <div class="filters-bar mt-3">
        <form class="row g-2 align-items-center" id="filtersForm" method="get" action="{{ url_for('scoreboard') }}">
            <div class="col-auto">
                <select class="form-select filter-select" name="time" onchange="document.getElementById('filtersForm').submit()">
                    <option value="all" {% if time_filter == 'all' %}selected{% endif %}>All Time</option>
                    <option value="day" {% if time_filter == 'day' %}selected{% endif %}>Last 24 Hours</option>
                    <option value="week" {% if time_filter == 'week' %}selected{% endif %}>Last Week</option>
                    <option value="month" {% if time_filter == 'month' %}selected{% endif %}>Last Month</option>
                </select>
            </div>
            <div class="col-auto">
                <select class="form-select filter-select" name="category" onchange="document.getElementById('filtersForm').submit()">
                    <option value="all" {% if category_filter == 'all' %}selected{% endif %}>All Categories</option>
                    {% for category in categories %}
                        <option value="{{ category }}" {% if category_filter == category %}selected{% endif %}>{{ category }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-auto">
                <button class="btn btn-outline-primary" type="submit"><i class="fas fa-filter me-1"></i>Apply</button>
            </div>
        </form>
    </div>

    <div class="stats-overview">
        <div class="stat-card">
            <div class="stat-number">{{ total_users }}</div>
            <div class="stat-label">Total Players</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ total_challenges }}</div>
            <div class="stat-label">Challenges</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ total_solves }}</div>
            <div class="stat-label">Total Solves</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ avg_score|round(1) }}</div>
            <div class="stat-label">Average Score</div>
        </div>
    </div>
</div>

<div class="table-wrap mb-3">
    <table class="scoreboard-table">
        <thead>
            <tr>
                <th style="width: 90px;">Rank</th>
                <th>Username</th>
                <th class="text-center" style="width: 120px;">Solves</th>
                <th class="text-center" style="width: 140px;">Score</th>
                <th class="text-center" style="width: 120px;">Medal</th>
            </tr>
        </thead>
        <tbody>
            {% for user in users %}
            <tr class="{% if user.is_current_user %}current{% endif %} {% if user.rank <= 3 %}top{{ user.rank }}{% endif %}">
                <td class="rank">{{ user.rank }}</td>
                <td class="username">
                    {{ user.username }}
                    {% if user.country %}
                        <span class="text-muted" style="font-size:.85rem">({{ user.country }})</span>
                    {% endif %}
                </td>
                <td class="solves">{{ user.solve_count }}</td>
                <td class="score">{{ user.score }}</td>
                <td class="medals">
                    {% if user.rank == 1 %}ðŸ¥‡{% elif user.rank == 2 %}ðŸ¥ˆ{% elif user.rank == 3 %}ðŸ¥‰{% else %}<i class="fas fa-medal text-muted"></i>{% endif %}
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="5" class="text-center text-muted py-3">No users found.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% if recent_solves %}
<div class="recent-activity">
    <h5 class="mb-2"><i class="fas fa-clock me-2"></i>Recent Solves</h5>
    {% for solve in recent_solves %}
    <div class="activity-item">
        <div>
            <strong>{{ solve.username }}</strong> solved <span class="text-primary">{{ solve.title }}</span>
            <span class="text-success">({{ solve.points }} pts)</span>
        </div>
        <div class="activity-time">{{ solve.timestamp.strftime('%H:%M') }}</div>
    </div>
    {% endfor %}
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
    // Optional auto-refresh every 30 seconds
    // setInterval(() => window.location.reload(), 30000);
</script>
{% endblock %}
